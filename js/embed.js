!function(e,t,a){function i(e,t){for(var a in t)t[a]&&(e[a]?e[a].set(t[a]):e[a]=new nt(t[a]))}function s(e,t){for(var a in t)e[a]=t[a]}function n(){if(!g.checkPermission())for(var t;t=U.shift();){var a=g.createNotification(t.iconUrl,t.title,t.body),i=t.url;try{a.onclick=function(){e.focus(),h.href=i,a.cancel()}}catch(s){}a.show(),setTimeout(function(){a.cancel&&a.cancel()},8e3)}}function o(){return 0==dt.data.user_id}function r(e,t,a){if(v)try{v.removeItem(e),v.removeItem(e+":timestamp"),v[e]=f.stringify(t),v[e+":timestamp"]=Math.floor(a)}catch(i){}}function d(e){P.theme=e,"none"!=e&&P.injectStylesheet(E+"/styles/embed"+(e?"."+e+".css?"+S[e]:"."+short_name)+".css")}if(!e.DUOSHUO){var l,c,u,p,h=e.location,f=e.JSON,m=e.XMLHttpRequest,v=f&&f.stringify&&e.localStorage,g=e.webkitNotifications,b=t.getElementsByTagName("head")[0]||t.getElementsByTagName("body")[0],y=e.navigator.userAgent,x="https:"==t.location.protocol?"https:":"http:",w=0,_=function(){var e={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},t=/&(?!\w+;)|[<>"'`]/g,a=/[&<>"'`]/,i=function(t){return e[t]||"&amp;"};return function(e){return null==e||e===!1?"":a.test(e)?e.replace(t,i):e}}(),k=function(e){if(e.match(/^(http|https):/))return e;var a=t.createElement("a");return a.href=e,O.hrefNormalized?a.href:a.getAttribute("href",4)},T={start:0,end:0},C=function(){var e,a,i,s,n,o=this,r=0,d=0;t.selection&&(a=t.selection.createRange(),a&&a.parentElement()==o&&(s=o.value.length,e=o.value.replace(/\r\n/g,"\n"),i=o.createTextRange(),i.moveToBookmark(a.getBookmark()),n=o.createTextRange(),n.collapse(!1),i.compareEndPoints("StartToEnd",n)>-1?r=d=s:(r=-i.moveStart("character",-s),r+=e.slice(0,r).split("\n").length-1,i.compareEndPoints("EndToEnd",n)>-1?d=s:(d=-i.moveEnd("character",-s),d+=e.slice(0,d).split("\n").length-1)))),T.start=r,T.end=d},j=function(e){return function(){return e}},S={"default":"d6149e1c",dark:"c11b5925",bluebox:"dbc0a9af"},E=x+"//static.duoshuo.com",P=e.DUOSHUO={DOMAIN:"duoshuo.com",REMOTE:"http://duoshuo.com",version:140327,loaded:{jQuery:"undefined"!=typeof jQuery&&jQuery.fn.jquery>="1.5",smilies:!1,mzadxN:"undefined"!=typeof mzadxN},libs:{jQuery:E+"/libs/embed.compat.js?24f8ca3f.js",smilies:E+"/libs/smilies.js?921e8eda.js",mzadxN:"http://js.miaozhen.com/mz_ad_serving.js"},sourceName:{weibo:"新浪微博",qq:"QQ",qzone:"QQ空间",qqt:"腾讯微博",renren:"人人网",douban:"豆瓣网",netease:"网易微博",kaixin:"开心网",sohu:"搜狐微博",baidu:"百度",taobao:"淘宝",msn:"MSN",google:"谷歌"},serviceNames:{weibo:"微博",qq:"QQ",douban:"豆瓣",renren:"人人",netease:"网易",kaixin:"开心",sohu:"搜狐",baidu:"百度",taobao:"淘宝",msn:"MSN",google:"谷歌"},parseDate:function(e){return e.parse("2011-10-28T00:00:00+08:00")&&function(t){return new e(t)}||e.parse("2011/10/28T00:00:00+0800")&&function(t){return new e(t.replace(/-/g,"/").replace(/:(\d\d)$/,"$1"))}||e.parse("2011/10/28 00:00:00+0800")&&function(t){return new e(t.replace(/-/g,"/").replace(/:(\d\d)$/,"$1").replace("T"," "))}||function(t){return new e(t)}}(Date),fullTime:function(e){var t=P.parseDate(e);return t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日 "+t.toLocaleTimeString()},elapsedTime:function(e){var t=P.parseDate(e),a=new Date,i=(a-w-t)/1e3;return 10>i?"刚刚":60>i?Math.round(i)+"秒前":3600>i?Math.round(i/60)+"分钟前":86400>i?Math.round(i/3600)+"小时前":(a.getFullYear()==t.getFullYear()?"":t.getFullYear()+"年")+(t.getMonth()+1)+"月"+t.getDate()+"日"},require:function(e,t){if("string"==typeof e)P.loaded[e]?t():B(P.libs[e],function(){P.loaded[e]=!0,t()});else if("object"==typeof e){var a,i=!0;for(a=0;a<e.length;a++)!function(s){P.loaded[e[a]]||(i=!1,B(P.libs[s],function(){P.loaded[s]=!0;for(var a=0;a<e.length;a++)if(!P.loaded[e[a]])return;t()}))}(e[a]);i&&t()}},getCookie:function(e){for(var i,s,n,o=" "+e+"=",r=t.cookie.split(";"),d=0;d<r.length;d++)if(i=" "+r[d],s=i.indexOf(o),s>=0&&s+o.length==(n=i.indexOf("=")+1))return decodeURIComponent(i.substring(n,i.length).replace(/\+/g,""));return a},param:function(e){var t=[];for(var i in e)e[i]!=a&&t.push(i+"="+encodeURIComponent(e[i]));return t.join("&")},ajax:function(e,t,i,s,n){function o(e,t,a){var i,o,r,d=t;if(e>=200&&300>e||304===e)if(304===e)d="notmodified",i=!0;else try{o=f.parse(a),d="success",i=!0}catch(l){d="parsererror",r=l}else{r=d,(!d||e)&&(d="error",0>e&&(e=0));try{o=f.parse(a)}catch(l){d="parsererror",r=l}}i?s(o):"parseerror"===d?Q("解析错误: "+a):(n&&n(o),Q("出错啦("+o.code+"): "+o.errorMessage),o.errorTrace&&Q(o.errorTrace))}var r=P.getCookie("duoshuo_token");if(i.v=P.version,r?i.jwt=r:p.remote_auth&&(i.remote_auth=p.remote_auth),m&&f&&f.parse){var d=new m;if(d&&"withCredentials"in d){var l;return d.open(e,P.hostUrl+t+".json"+("GET"==e?"?"+P.param(i):""),!0),d.withCredentials=!0,d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),d.send("GET"==e?null:P.param(i)),l=function(e,t){var i,s,n,r;try{if(l&&(t||4===d.readyState))if(l=a,t)4!==d.readyState&&d.abort();else{i=d.status,n=d.getAllResponseHeaders();try{r=d.responseText}catch(e){}try{s=d.statusText}catch(c){s=""}}}catch(u){t||o(-1,u)}r&&o(i,s,r,n)},4===d.readyState?l():d.onreadystatechange=l,void 0}}"GET"!=e&&(i._method="POST");var c="cb_"+Math.round(1e6*Math.random());P[c]=function(e){switch(e.code){case 0:s(e);break;default:n&&n(e),Q("出错啦("+e.code+"): "+e.errorMessage),e.errorTrace&&Q(e.errorTrace)}},i.callback="DUOSHUO['"+c+"']",B(P.hostUrl+t+".jsonp?"+P.param(i))},injectStylesheet:function(e){var a=t.createElement("link");a.type="text/css",a.rel="stylesheet",a.href=e,b.appendChild(a)},setCustomStyle:function(e){if(l||(l=t.createElement("style"),l.type="text/css",b.appendChild(l)),e=e.replace(/\}/g,"}\n"),l.styleSheet)l.styleSheet.cssText=e;else{for(;l.firstChild;)l.removeChild(l.firstChild);l.appendChild(t.createTextNode(e))}},compileStyle:function(e){var t="",a={textbox:"#ds-thread #ds-reset .ds-replybox .ds-textarea-wrapper"};if(e)for(var i in e)t+=a[i]+"{"+e[i]+"}\n";return t},init:function(e,t){e&&!M[e]&&(M[e]=t||{type:"EmbedThread"}),P.initView&&P.initView()}},q=t.all,O=P.support=function(){var a=t.createElement("div");a.innerHTML='<a href="/a">a</a><input type="checkbox"/>';var i=a.getElementsByTagName("a")[0],s=a.getElementsByTagName("input")[0],n={placeholder:"placeholder"in s,touch:"ontouchstart"in e||"onmsgesturechange"in e,hrefNormalized:"/a"===i.getAttribute("href"),iOS:y.match(/ \((iPad|iPhone|iPod);( U;)? CPU( iPhone)? OS /),android:y.match(/ \(Linux; U; Android /)};return c=!m&&"undefined"==typeof a.style.maxHeight,n.authInWin=e.postMessage&&e.screen.width>800&&!n.iOS&&!n.android&&h.origin,n}(),L=function(e,a){var i=(t.body||t.documentElement).style;if("undefined"==typeof i)return!1;if("string"==typeof i[e])return a?e:!0;for(var s=["Moz","Webkit","ms"],e=e.charAt(0).toUpperCase()+e.substr(1),n=0;n<s.length;n++)if("string"==typeof i[s[n]+e])return a?s[n]+e:!0},M=P.selectors={".ds-thread":{type:"EmbedThread"},".ds-recent-comments":{type:"RecentComments"},".ds-recent-visitors":{type:"RecentVisitors"},".ds-top-users":{type:"TopUsers"},".ds-top-threads":{type:"TopThreads"},".ds-login":{type:"LoginWidget"},".ds-thread-count":{type:"ThreadCount"}},R=P.pagelets=[],I={post:"发布",posting:"正在发布",settings:"设置",reply:"回复",like:"顶",repost:"转发",report:"举报","delete":"删除",reply_to:"回复 ",reposts:"转发",comments:"评论",floor:"楼",latest:"最新",earliest:"最早",hottest:"最热",share_to:"分享到:",leave_a_message:"说点什么吧…",no_comments_yet:"还没有评论，沙发等你来抢",repost_reason:"请输入转发理由",hot_posts_title:"被顶起来的评论",comments_zero:"暂无评论",comments_one:"1条评论",comments_multiple:"{num}条评论",reposts_zero:"暂无转发",reposts_one:"1条转发",reposts_multiple:"{num}条转发",weibo_reposts_zero:"暂无新浪微博",weibo_reposts_one:"1条新浪微博",weibo_reposts_multiple:"{num}条新浪微博",qqt_reposts_zero:"暂无腾讯微博",qqt_reposts_one:"1条腾讯微博",qqt_reposts_multiple:"{num}条腾讯微博"},H=function(e,t,a,i){P.ajax("GET",e,t,a||function(){},i)},W=function(e,t,a,i){P.ajax("POST",e,t,a||function(){},i)},U=[],A=[],z=function(t){return"WebSocket"in e&&f?(A.push(f.stringify(t)),u||(u=P.webSocket=new WebSocket("ws://ws.duoshuo.com:8201/"),u.onopen=function(){var e;if(1===u.readyState)for(;e=A.shift();)u.send(e)},u.onmessage=function(e){try{var t,a=0,i=f.parse(e.data)}catch(s){return}switch(i.type){case"post":for(;a<P.pagelets.length;a++)t=P.pagelets[a],t.threadId==i.thread_id&&t.onMessage(i);break;case"notification":U.push(i),n()}},e.addEventListener("beforeunload",function(){u.close()})),u.onopen(),void 0):!1},D=P.Collections={},N=P.Views={},V=(P.Callbacks={},P.openDialog=function(e){return P.dialog!==a&&P.dialog.el.remove(),P.dialog=new N.Dialog('<div class="ds-dialog"><div class="ds-dialog-inner ds-rounded"><div class="ds-dialog-body">'+e+'</div><div class="ds-dialog-footer"><a href="http://duoshuo.com/" target="_blank" class="ds-logo"></a><span>社会化评论框</span></div><a class="ds-dialog-close" href="javascript:void(0)" title="关闭"></a></div></div>').open()}),B=P.injectScript=function(i,s){var n=t.createElement("script"),o=t.head||t.getElementsByTagName("head")[0]||t.documentElement;n.type="text/javascript",n.src=i,n.async="async",n.charset="utf-8",s&&(n.onload=n.onreadystatechange=function(t,i){(i||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,o&&n.parentNode&&o.removeChild(n),n=a,i||s.call(e))}),o.insertBefore(n,o.firstChild)},Q=P.log=function(e){"object"==typeof console&&console.log(e)},Z=P.smilies={},F=["EmbedThread","RecentComments","RecentVisitors","TopUsers","TopThreads","LoginWidget","ThreadCount"],$=0,K=function(){for(var e={},t=0;t<arguments.length;t++)arguments[t]&&s(e,arguments[t]);var a=P.param(e);return a?"?"+a:""},J=function(){var e=P.getCookie("duoshuo_token");return e?{jwt:e}:p.remote_auth?{short_name:p.short_name,remote_auth:p.remote_auth}:a},X=function(){return!p&&(p=e.duoshuoQuery)&&ot.trigger("queryDefined"),p};for(var G in Object.prototype)return alert("Object.prototype不为空，请不要给Object.prototype设置方法");for(var Y=P.templates={userUrl:function(e){return e.url},avatarUrl:function(e){return e.avatar_url||rt.data.default_avatar_url},userAnchor:function(e){var t=Y.userUrl(e);return t?'<a rel="nofollow author" target="_blank" href="'+_(t)+'">'+_(e.name)+"</a>":_(e.name)},avatarImg:function(e,t){return'<img src="'+_(Y.avatarUrl(e,t))+'" alt="'+_(e.name)+'"'+(t?' style="width:'+t+"px;height:"+t+'px"':"")+"/>"},avatar:function(e,t){var a=Y.avatarImg(e,t),i=Y.userUrl(e);return i?'<a rel="nofollow author" target="_blank" href="'+_(i)+'" '+(e.user_id?" onclick=\"this.href='"+P.hostUrl+"/user-url/?user_id="+e.user_id+"';\"":"")+' title="'+_(e.name)+'">'+a+"</a>":a},timeHtml:function(e,t){return e?t?'<a href="'+t+'" target="_blank" rel="nofollow" class="ds-time" datetime="'+e+'" title="'+P.fullTime(e)+'">'+P.elapsedTime(e)+"</a>":'<span class="ds-time" datetime="'+e+'" title="'+P.fullTime(e)+'">'+P.elapsedTime(e)+"</span>":""},serviceIcon:function(e,t){return'<a href="javascript:void(0)" class="ds-service-icon'+(t?"-grey":"")+" ds-"+e+'" data-service="'+e+'" title="'+P.sourceName[e]+'"></a>'},loginButtons:function(){return'<div class="ds-login-buttons"><p>社交帐号登录:</p><div class="ds-social-links">'+Y.serviceList()+Y.additionalServices()+"</div></div>"},poweredBy:function(e){return'<p class="ds-powered-by"><a href="http://duoshuo.com" target="_blank" rel="nofollow">'+_(e)+"</a></p>"},indicator:j('<div id="ds-indicator"></div>'),waitingImg:j('<div id="ds-waiting"></div>'),serviceList:function(e){for(var t='<ul class="ds-service-list">',a=["weibo","qq","renren","douban"],i=0;i<a.length;i++)t+=Y.loginItem(a[i],e);return t+'<li><a class="ds-more-services" href="javascript:void(0)">更多»</a></li>'+"</ul>"},additionalServices:function(e){for(var t='<ul class="ds-service-list ds-additional-services">',a=["kaixin","netease","sohu","baidu","google"],i=0;i<a.length;i++)t+=Y.loginItem(a[i],e);return t+"</ul>"},loginItem:function(e,t){var a=Y[t?"bindUrl":"loginUrl"](e);return'<li><a href="'+a+'" rel="nofollow" class="ds-service-link ds-'+e+'">'+P.serviceNames[e]+(dt.data.social_uid[e]?' <span class="ds-icon ds-icon-ok"></span>':"")+"</a>"+"</li>"},loginUrl:function(e,t){return t||(t={}),p.sso&&p.sso.login&&(t.sso=1,t.redirect_uri=p.sso.login),P.hostUrl+"/login/"+e+"/"+K(t)},bindUrl:function(e){return P.hostUrl+"/bind/"+e+"/"+K(p.sso&&p.sso.login?{sso:1,redirect_uri:p.sso.login}:null,J())},logoutUrl:function(){return P.hostUrl+"/logout/"+K(p.sso&&p.sso.logout?{sso:1,redirect_uri:p.sso.logout}:null)},likePost:function(e){return'<a class="ds-post-likes" href="javascript:void(0);"><span class="ds-icon ds-icon-like"></span>'+I.like+(e.likes>0?"("+e.likes+")":"")+"</a>"},ctxPost:function(e,t,a){var i=et(e);return'<li class="ds-ctx-entry"'+(a?' style="display:none"':"")+' data-post-id="'+e.post_id+'"><div class="ds-avatar">'+Y.avatar(i)+'</div><div class="ds-ctx-body"><div class="ds-ctx-head">'+Y.userAnchor(i)+Y.timeHtml(e.created_at,e.url)+(t>=0?'<div class="ds-ctx-nth" title="'+P.fullTime(e.created_at)+'">'+(t+1)+I.floor+"</div>":"")+'</div><div class="ds-ctx-content">'+e.message+(t>=0?'　　　　　　　<div class="ds-comment-actions'+(e.vote>0?" ds-post-liked":"")+'">'+Y.likePost(e)+' <a class="ds-post-repost" href="javascript:void(0);"><span class="ds-icon ds-icon-share"></span>'+I.repost+"</a>"+' <a class="ds-post-reply" href="javascript:void(0);"><span class="ds-icon ds-icon-reply"></span>'+I.reply+"</a>"+"</div>":"")+"</div></div></li>"}},et=function(e){return pt[e.author_id]&&pt[e.author_id].data||e.author},tt=function(e){var t=[];for(var a in e)t.push('<input type="hidden" name="'+a+'" value="'+_(e[a])+'" />');return t.join("\n")};$<F.length;$++)P[F[$]]=function(e){return function(t,a){a=a||{},a.type=e,t&&!M[t]&&(M[t]=a),P.initSelector&&P.initSelector(t,a)}}(F[$]),P["create"+F[$]]=function(e){return function(a,i){var s=t.createElement(a);for(var n in i)s.setAttribute("data-"+n,i[n]);return P[e](s),s}}(F[$]);P.RecentCommentsWidget=P.RecentComments;var at=0,it=P.Class=function(){};it.extend=function(e){function t(){!at&&this.init&&this.init.apply(this,arguments)}at=1;var a=new this;at=0;for(var i in e)a[i]=e[i];return t.prototype=a,t.prototype.constructor=t,t.extend=arguments.callee,t};var st=P.Event=it.extend({on:function(e,t){var i=this.handlers||(this.handlers={});return i[e]===a&&(i[e]=[]),i[e].push(t),this},trigger:function(e,t){var a=(this.handlers||(this.handlers={}))[e];if(a)for(var i=0;i<a.length&&a[i].call(this,t)!==!1;i++);return this}}),nt=P.Model=st.extend({init:function(e){this.data=e},reset:function(e){this.data=e,this.trigger("reset")},remove:function(e){this.data.splice(e,1),this.trigger("reset")},set:function(e,t){if(t===a)for(var i in e)this.data[i]=e[i];else this.data[e]=t;this.trigger("reset")}}),ot=P.events=new st,rt=P.site=new nt,dt=P.visitor=new nt,lt=P.unread=new nt,ct=P.threads={},ut=P.postPool={},pt=P.users={};ot.on("queryDefined",function(){var e=p.short_name;if(P.hostUrl=e?x+"//"+e+"."+P.DOMAIN:P.REMOTE,p.theme&&d(p.theme),v){var t=v["ds_site_"+e],a=v["ds_lang_"+e];t&&rt.reset(f.parse(t)),a&&s(I,f.parse(a))}}),X(),P.loaded.jQuery&&(P.jQuery=e.jQuery),P.require("jQuery",function(){function l(e,t,a){return e.find(".ds-post[data-post-id="+t.post_id+"]")[0]?void 0:(e.find(".ds-post-placeholder").remove(),x(Y.post(t,a)).hide()["asc"==a.order?"appendTo":"prependTo"](e).slideDown(function(){}))}function u(e,t){var a;this.delegate("a.ds-post-likes","click",function(){if(o())return m(),!1;var e=x(this).parent();return liked=e.hasClass("ds-post-liked"),matches=x(this).html().match(/\((\d+)\)/),likes=(matches?parseInt(matches[1]):0)+(liked?-1:1),W("/api/posts/vote",{post_id:e.closest(".ds-ctx-entry, .ds-post-self").attr("data-post-id"),vote:liked?0:1}),x(this).html(x(this).html().replace(/\(\d+\)/,"")+(likes?"("+likes+")":"")),e[liked?"removeClass":"addClass"]("ds-post-liked"),!1}).delegate("a.ds-post-repost","click",function(){var e=x(this).closest(".ds-post-self"),t=ut[e.attr("data-post-id")];return P.repostDialog(t,""),!1}).delegate("a.ds-post-delete","click",function(){if(confirm("确定要删除这条评论吗？")){var t=x(this).closest(".ds-post-self");W("/api/posts/remove",{post_id:t.attr("data-post-id")}),t.parent().fadeOut(200,function(){e.data.comments--,e.updateCounter("duoshuo"),x(this).remove()})}return!1}).delegate("a.ds-post-report","click",function(){if(confirm("确定要举报这条评论吗？")){var e=x(this).closest(".ds-post-self");W("/api/posts/report",{post_id:e.attr("data-post-id")}),alert("感谢您的反馈！")}return!1}).delegate("a.ds-post-reply","click",function(){var i=x(this),s=i.closest(".ds-comment-actions");if(s.hasClass("ds-reply-active"))a.el.fadeOut(200,function(){x(this).detach()}),s.removeClass("ds-reply-active");else{var n=i.closest(".ds-ctx-entry, .ds-post-self");a?a.actionsBar.removeClass("ds-reply-active"):(a=new N.Replybox(e),a.render(!0).el.addClass("ds-inline-replybox").detach()),a.el.find("[name=parent_id]").val(n.attr("data-post-id")),a.el.show().appendTo(i.closest(".ds-ctx-body, .ds-comment-body")).find("textarea").focus(),a.actionsBar=s.addClass("ds-reply-active"),t.max_depth<=1?a.postList=e.postList.el:(a.postList=n.siblings(".ds-children"),a.postList[0]||(a.postList=x('<ul class="ds-children"></ul>').insertAfter(n)))}return!1}).delegate("a.ds-weibo-comments","click",function(){var e=x(this).closest(".ds-post-self"),a=e.attr("data-post-id");if(e.data("source"),0==e.attr("data-root-id")){var i=e.siblings(".ds-children");i[0]?i.remove():(i=x('<ul class="ds-children"></ul>').insertAfter(e),H("/api/posts/listComments",b({post_id:a}),function(e){U(e),i.append(x.map(e.response,function(e){return Y.post(e,t)}).join(""))}))}return!1}).delegate("a.ds-weibo-reposts","click",function(){var t=x(this).closest(".ds-post-self"),a=ut[t.attr("data-post-id")],i=a.data.source;if(!dt.data.social_uid["qqt"==i?"qq":i])return f(i),void 0;var s=a.data.root_id,n="0"!=s?ut[s]:a,o="";if("0"!=s){var r=et(a.data);o=("weibo"==i?"//@"+r.name:"|| @"+r.qqt_account)+":"+a.data.message}return P.repostDialog(n,o,e,i),!1}).delegate("a.ds-expand","click",function(){var e=x(this).parent();return e.siblings().show(),e.remove(),!1}),O.touch||this.delegate("a.ds-comment-context, .ds-avatar, .ds-user-name","mouseenter",function(){var t=this;if(bubbleOutTimer&&mt.owner==t)clearTimeout(bubbleOutTimer),bubbleOutTimer=0;else{var a=x(t);gt=setTimeout(function(){gt=0,mt.owner=t,bt();var i=a.offset(),s=e.el.offset(),n=a.innerWidth()/2,o=e.el.innerHeight()-(i.top-s.top)+6,r=i.left-s.left-35+(n>35?35:n);try{if(a.hasClass("ds-comment-context"))vt.attr("id","ds-ctx-bubble").attr("data-post-id",a.attr("data-post-id")).html('<ul id="ds-ctx">'+Y.ctxPost(ut[a.attr("data-parent-id")].data)+"</ul>"+'<div class="ds-bubble-footer"><a class="ds-ctx-open" href="javascript:void(0);">查看对话</a></div>');else if(a.hasClass("ds-avatar")||a.hasClass("ds-user-name")){var d={},l=d.user_id=a.attr("data-user-id");if(!l)throw"no info";vt.attr("id","ds-user-card").attr("data-user-id",l).empty(),pt[l]?vt.html(Y.userInfo(pt[l].data)):H("/api/users/profile",b(d),function(e){var a=e.response;pt[l]?pt[l].set(a):pt[l]=new nt(a),mt.owner==t&&vt.html(Y.userInfo(a))})}mt.css({bottom:o,left:r}).appendTo(e.innerEl)}catch(c){mt.detach()}},200)}}).delegate("a.ds-comment-context, .ds-avatar, .ds-user-name","mouseleave",function(){gt?(clearTimeout(gt),gt=0):bubbleOutTimer||bubbleOut()})}function f(e){var t=Y[o()?"loginUrl":"bindUrl"](e);O.authInWin&&$(e,t)||(h.href=t)}function m(){var e=V("<h2>社交帐号登录</h2>"+Y.serviceList()+Y.additionalServices()).el.find(".ds-dialog").css("width","300px");G(e)}function b(e){var a={require:"site,visitor,nonce,serverTime,lang"+(yt++?"":",unread,log,extraCss"),site_ims:v&&v["ds_site_"+p.short_name+":timestamp"],lang_ims:v&&v["ds_lang_"+p.short_name+":timestamp"],referer:t.referrer};p.stylePatch&&(a.style_patch=p.stylePatch);for(var i in a)a[i]&&(!c||encodeURIComponent(a[i]).length<200)&&(e[i]=a[i]);return e}var x=P.jQuery,j=x(e),S=x(t),U=P.loadRequire=function(e){if(e.serverTime&&(w=(new Date).getTime()-1e3*e.serverTime),e.visitor&&(!dt.data&&e.visitor.user_id&&g&&!g.checkPermission()&&z({logged_user_id:e.visitor.user_id}),dt.reset(e.visitor)),e.site&&(rt.reset(e.site),r("ds_site_"+p.short_name,e.site,e.serverTime)),!P.theme&&rt.data.theme&&d(rt.data.theme),e.lang&&(s(I,e.lang),r("ds_lang_"+p.short_name,e.lang,e.serverTime)),e.stylesheets)for(var t=0;t<e.stylesheets.length;t++)P.injectStylesheet(e.stylesheets[t]);e.nonce&&(P.nonce=e.nonce),e.style&&P.setCustomStyle((e.style||"")+P.compileStyle(p.component_style)),e.unread&&lt.reset(e.unread)},A=function(e){e.stopPropagation()},B=function(e){(e.ctrlKey&&13==e.which||10==e.which)&&x(this.form).trigger("submit")},F=function(){var e=x(this);e.height(Math.max(54,e.next(".ds-hidden-text").text(this.value).height()+27))},$=function(t,a){var i={weibo:[760,600],renren:[420,322],qq:[504,445],netease:[810,645],sohu:[972,600],google:[600,440],taobao:[480,585]}[t]||[550,400];return e.open(a+(-1==a.indexOf("?")?"?":"&")+P.param({origin:h.origin||"http://"+h.host}),"_blank","width="+i[0]+",height="+i[1]+",toolbar=no,menubar=no,location=yes")},G=function(e,t){O.authInWin&&e.find(t||"a.ds-service-link").click(function(){var e=this.href.match(/\/(login|bind)\/(\w+)\//i);if(e&&P.serviceNames[e[2]])return!$(e[2],this.href)})},at=function(e){return O.touch&&e.addClass("ds-touch"),L("transition")||e.addClass("ds-no-transition"),c&&e.addClass("ds-ie6"),x.support.opacity||e.addClass("ds-no-opacity"),e},it=function(e){if(!O.placeholder){var t=e.attr("placeholder");e.val(t).focus(function(){this.value===t&&(this.value="")}).blur(function(){""===this.value&&(this.value=t)})}return e};if(e.postMessage){var ot=function(e){if("http://duoshuo.com"===e.origin)switch(e.data.type){case"login":h.href=e.data.redirectUrl}};e.addEventListener?e.addEventListener("message",ot,!1):e.attachEvent&&e.attachEvent("onmessage",ot)}P.scrollTo=function(e){var t=e.offset().top;(t<j.scrollTop()||t>j.scrollTop()+j.height())&&x("html, body").animate({scrollTop:t-40},200,"swing")},P.toJSON=function(e){var t=/\r?\n/g,a=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,i=/^(?:select|textarea)/i,s=e.map(function(){return this.elements?x.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||i.test(this.nodeName)||a.test(this.type))}).map(function(e,a){var i=x(this).val();return null==i?null:x.isArray(i)?x.map(i,function(e){return{name:a.name,value:e.replace(t,"\r\n")}}):{name:a.name,value:i.replace(t,"\r\n")}}).toArray(),n={};return x.each(s,function(){n[this.name]=this.value}),n};var ht=P.Widget=st.extend({init:function(e,t){this.el=e,this.options=t||{},this.render()},render:function(){},reset:function(){},load:function(e){switch(e.code){case 0:U(e),this.onload(e);break;default:this.onError(e)}},onload:function(e){this.el.html(Y[this.tmpl].call(Y,e.response,x.extend(this.options,e.options)))},onMessage:function(){},onError:function(e){Q("出错啦("+e.code+"): "+e.errorMessage),e.errorTrace&&Q(e.errorTrace)}}),ft=function(e){var t={"unread-comments":{title:"新留言及回复",apiUrl:"/api/users/unreadComments",tmpl:function(e){return'<li data-thread-id="'+e.thread.thread_id+'">'+x.map(e.authors,Y.userAnchor).join("、")+' 在 <a class="ds-read" href="'+e.thread.url+'#comments" target="_blank">'+_(e.thread.title||"无标题")+'</a> 中回复了你 <a class="ds-delete ds-read" title="知道了" href="javascript:void(0)">知道了</a></li>'},read:function(e){var t=e.attr("data-thread-id");W("/api/threads/read",{thread_id:t}),lt.data.comments--}},"unread-notifications":{title:"系统消息",apiUrl:"/api/users/unreadNotifications",tmpl:function(e){return'<li data-notification-id="'+e.notification_id+'" data-notification-type="'+e.type+'">'+e.content+' <a class="ds-delete ds-read" title="知道了" href="javascript:void(0)">知道了</a></li>'},read:function(e){var t=e.attr("data-notification-id");W("/api/notifications/read",{notification_id:t}),lt.data.notifications--}}}[e],a=V("<h2>"+t.title+"</h2>"+'<ul class="ds-unread-list"></ul>');a.on("close",P.resetNotify);var i=a.el.find(".ds-unread-list").delegate(".ds-delete","click",function(){return x(this).parent().remove(),0===i.children().length&&a.close(),!1}).delegate(".ds-read","click",function(){t.read(x(this).parent())});x("#ds-notify").hide(),H(t.apiUrl,{},function(e){a.el.find(".ds-unread-list").html(x.map(e.response,t.tmpl).join("\n"))}),g&&g.checkPermission()&&g.requestPermission(n)};P.resetNotify=function(){var e=x("#ds-notify"),a=lt.data;e[0]||(e=x('<div id="ds-notify"></div>').css({hidden:{display:"none"},"top-right":{top:"24px",right:"24px"},"bottom-right":{bottom:"24px",right:"24px"}}[rt.data.notify_position]).delegate(".ds-notify-unread a","click",function(){return ft(x(this).data("type")),!1}).appendTo(t.body)),e.html('<div id="ds-reset"><a class="ds-logo" href="http://duoshuo.com/" target="_blank" title="多说"></a><ul class="ds-notify-unread"><li'+(a.comments?"":' style="display:none;"')+'><a data-type="unread-comments" href="javascript:void(0);">你有'+a.comments+"条新回复</a></li><li"+(a.notifications?"":' style="display:none;"')+'><a data-type="unread-notifications" href="javascript:void(0);">你有'+a.notifications+"条系统消息</a></li></ul></div>")[!a.comments&&!a.notifications||"hidden"===rt.data.notify_position||x(".ds-dialog")[0]?"hide":"show"]()},lt.on("reset",P.resetNotify),Y.replybox=function(e,t){var a,i=e.options,s=dt.data,n=[],r="",d={thread_id:e.threadId,parent_id:"",nonce:P.nonce};for(var l in s.repostOptions)s.repostOptions[l]&&(n.push(l),a=1),r+=Y.serviceIcon(l,!s.repostOptions[l]);return'<div class="ds-replybox"><a class="ds-avatar"'+(o()?' href="javascript:void(0);" onclick="return false"':' href="'+P.REMOTE+"/settings/avatar/"+K(J())+'" target="_blank" title="设置头像"')+">"+Y.avatarImg(s)+"</a>"+'<form method="post">'+tt(d)+'<div class="ds-textarea-wrapper ds-rounded-top">'+'<textarea name="message" title="Ctrl+Enter快捷提交" placeholder="'+_(I.leave_a_message)+'"></textarea>'+'<pre class="ds-hidden-text"></pre>'+"</div>"+'<div class="ds-post-toolbar">'+'<div class="ds-post-options ds-gradient-bg">'+'<span class="ds-sync">'+(!o()&&r?'<input id="ds-sync-checkbox'+(t?"-inline":"")+'" type="checkbox" name="repost" '+(a?'checked="checked" ':"")+'value="'+n.join(",")+'"> <label for="ds-sync-checkbox'+(t?"-inline":"")+'">'+I.share_to+"</label>"+r:"")+"</span>"+"</div>"+'<button class="ds-post-button" type="submit">'+_(I.post)+"</button>"+'<div class="ds-toolbar-buttons">'+(i.use_smilies?'<a class="ds-toolbar-button ds-add-emote" title="插入表情"></a>':"")+(i.use_images&&i.parse_html_enabled?'<a class="ds-toolbar-button ds-add-image" title="插入图片"></a>':"")+"</div>"+"</div>"+"</form>"+"</div>"},N.Replybox=function(e){this.embedThread=e},N.Replybox.prototype={render:function(e){function a(e){e.data("submitting",!0),e.find(".ds-post-button").addClass("ds-waiting").html(I.posting)[0].disabled=!0}function i(e){e.data("submitting",!1),e.find(".ds-post-button").removeClass("ds-waiting").html(I.post)[0].disabled=!1}var s=this,n=s.embedThread,r=n.options,d=function(){P.require("smilies",function(){})},c=s.el=x(Y.replybox(n,e)).click(d),u=c.find("form"),p=u.find("input[type=checkbox]")[0],h=u.find("a.ds-service-icon, a.ds-service-icon-grey"),f=it(u.find("textarea")).focus(d).keyup(B).keyup(F).bind("focus mousedown mouseup keyup",C),m=c.find(".ds-add-emote").click(function(e){var a=P.smiliesTooltip;return m.toggleClass("ds-expanded").hasClass("ds-expanded")?(a||(a=P.smiliesTooltip=new N.SmiliesTooltip,a.render(),P.require("smilies",function(){a.reset("微博-默认")})),a.replybox=s,a.el.appendTo(t.body).css({top:s.el.offset().top+s.el.outerHeight()+4+"px",left:s.el.find(".ds-textarea-wrapper").offset().left+"px"}),x(t.body).click(g)):g(e),!1}),g=(c.find(".ds-add-image").click(function(e){var a=f[0],i=a.value,s="请输入图片地址",n='<img src="'+s+'" />';if(t.selection){a.value=i.substring(0,T.start)+n+i.substring(T.end,i.length),a.value=a.value.replace("说点什么吧 ...",""),a.focus();var o=t.selection.createRange();o.collapse(),o.findText(s),o.select()}else{a.value=i.substring(0,a.selectionStart)+n+i.substring(a.selectionEnd);var r=a.value.search(s);a.setSelectionRange(r,r+s.length),a.focus()}e.preventDefault()}),s.hideSmilies=function(){m.removeClass("ds-expanded"),P.smiliesTooltip.el.detach(),x(t.body).unbind("click",g)}),b=function(e,t){var a=V('<h2>社交帐号登录</h2><div class="ds-icons-32">'+x.map(["weibo","qq","renren","kaixin","douban","netease","sohu"],function(e){return'<a class="ds-'+e+'" href="'+Y.loginUrl(e)+'">'+P.sourceName[e]+"</a>"}).join("")+"</div>"+(r.deny_anonymous?"":'<h2>作为游客留言</h2><form><div class="ds-control-group"><input type="text" name="author_name" id="ds-dialog-name" value="'+_(dt.data.name)+'" required />'+'<label for="ds-dialog-name">名字(必填)</label>'+"</div>"+(r.require_guest_email?'<div class="ds-control-group"><input type="email" name="author_email" id="ds-dialog-email" value="'+_(dt.data.email)+'" required />'+'<label for="ds-dialog-email">邮箱(必填)</label>'+"</div>":"")+(r.require_guest_url?'<div class="ds-control-group"><input type="url" name="author_url" id="ds-dialog-url" placeholder="http://" value="'+_(dt.data.url||"")+'" />'+'<label for="ds-dialog-url">网址(可选)</label>'+"</div>":"")+'<button type="submit">发布</button>'+"</form>")),i=a.el.find(".ds-dialog").css("width","320px");if(G(i,".ds-icons-32 a"),!r.deny_anonymous){var s=a.el.find("form");s.submit(function(){var e=s.find("input[name=author_email]").val();return!e&&!r.require_guest_email||e.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)?(t(P.toJSON(s)),a.close(),!1):(alert("请输入一个有效的email地址."),!1)}),s.find("input[name=author_name]")[0].focus()}};r.deny_anonymous&&f.focus(function(){if(o()){b(u,y);var e=function(t){t.stopPropagation(),f.unbind("click",e)};f.click(e)}return!1});var y=function(e){a(u),W("/api/posts/create",x.extend(P.toJSON(u),e),function(e){var t=e.response,a=l(s.postList,t,r);if("asc"==r.order==("top"==r.formPosition)&&P.scrollTo(a),ut[t.post_id]=new nt(t),n.data.comments++,n.updateCounter("duoshuo"),f.val("").trigger("keyup"),i(u),c.hasClass("ds-inline-replybox")&&(c.detach(),s.actionsBar.removeClass("ds-reply-active")),v)try{v.removeItem("ds_draft_"+n.threadId)}catch(o){}},function(e){i(u),alert(e.errorMessage)})};u.submit(function(){if(u.data("submitting"))return!1;var e=x.trim(u[0].message.value);return""==e||!O.placeholder&&e==f.attr("placeholder")?(alert("您还没写内容呢"),!1):(o()?b(u,y):y(),!1)});var w=function(e){return x(e).hasClass("ds-service-icon-grey")?null:x(e).attr("data-service")};return h.click(function(){return x(this).toggleClass("ds-service-icon-grey").toggleClass("ds-service-icon"),p.value=x.map(h,w).join(","),p.checked=""!=p.value,!1}),x(p).change(function(){var e=this.checked;h[e?"removeClass":"addClass"]("ds-service-icon-grey")[e?"addClass":"removeClass"]("ds-service-icon"),this.value=x.map(h,w).join(",")}),this}},N.Dialog=st.extend({init:function(e,t){(this.el=x("#ds-wrapper"))[0]||(this.el=at(x('<div id="ds-wrapper"></div>'))),this.options=x.extend({width:600},t),e!==a&&x(e).attr("id","ds-reset").appendTo(this.el)},open:function(){var e=this;e.el.hide().appendTo(t.body).fadeIn(200),c&&e.el.css("top",j.scrollTop()+100),e.el.show().find(".ds-dialog").delegate("a.ds-dialog-close","click",function(){return e.close(),!1}).click(A);var a=function(t){return 27==t.which?(e.close(),!1):void 0},i=function(){return e.close(),!1};return S.keydown(a),x(t.body).click(i),e.close=function(){S.unbind("keydown",a),x(t.body).unbind("click",i),e.el.fadeOut(200,function(){x(this).remove()}),e.trigger("close")},e}}),Y.likePanel=function(e){return e.likes?'<span class="ds-highlight">'+e.likes+"</span> 人喜欢":""},Y.likeTooltip=function(e){var t={qzone:"QQ空间",weibo:"新浪微博",qqt:"腾讯微博",renren:"人人网",kaixin:"开心网",douban:"豆瓣网",baidu:"百度搜藏",netease:"网易微博",sohu:"搜狐微博"},a=[];for(var i in t)a.push('<li><a class="ds-share-to-'+i+" ds-service-link ds-"+i+'" href="'+P.hostUrl+"/share-proxy/?"+P.param({service:i,thread_id:e.thread_id})+'">'+t[i]+"</a></li>");var s=Math.ceil(a.length/2);
return'<div class="ds-like-tooltip ds-rounded"><p>很高兴你能喜欢，分享一下吧：</p><ul>'+a.slice(0,s).join("")+"</ul><ul>"+a.slice(s).join("")+'</ul><p class="ds-like-tooltip-footer"><a class="ds-like-tooltip-close">算了</a></p></div>'},N.Meta=function(e){this.embedThread=e},N.Meta.prototype={render:function(){var i=this,s=i.embedThread,n=s.data,r=i.el=x('<div class="ds-meta"><a href="javascript:void(0)" class="ds-like-thread-button ds-rounded'+(n.user_vote>0?" ds-thread-liked":"")+'"><span class="ds-icon ds-icon-heart"></span>'+' <span class="ds-thread-like-text">'+(n.user_vote>0?"已喜欢":"喜欢")+'</span><span class="ds-thread-cancel-like">取消喜欢</span></a><span class="ds-like-panel"></span></div>'),d=r.find(".ds-like-thread-button").click(function(o){var l=d.hasClass("ds-thread-liked");W("/api/threads/vote",{thread_id:s.threadId,vote:l?0:1},function(e){x.each(e.response.thread,function(e,t){n[e]=t}),i.resetLikePanel()}),d.toggleClass("ds-thread-liked"),d.find(".ds-thread-like-text").text(l?"喜欢":"已喜欢");var c=function(){i.tooltip.detach(),x(t.body).unbind("click",c)};return l?i.tooltip&&c(o):(i.tooltip===a&&(i.tooltip=x(Y.likeTooltip(n)).click(A).delegate("a","click",function(t){switch(this.className){case"ds-like-tooltip-close":c(t);break;default:if(!e.open(this.href,"_blank","height=500,width=600,top=0,left=0,toolbar=no,menubar=no,resizable=yes,location=yes,status=no"))return}return!1})),i.tooltip.appendTo(s.innerEl).css({top:r.position().top+r.outerHeight()-4+"px",left:0}),x(t.body).click(c)),!1});return i.resetLikePanel(),o()&&r.hide(),i},resetLikePanel:function(){this.el.find(".ds-like-panel").html(Y.likePanel(this.embedThread.data))}},Y.postListHead=function(e){var t=e.data,a=e.options;return'<div class="ds-comments-info"><div class="ds-sort"><a class="ds-order-desc">'+I.latest+'</a><a class="ds-order-asc">'+I.earliest+'</a><a class="ds-order-hot">'+I.hottest+'</a></div><ul class="ds-comments-tabs"><li class="ds-tab"><a class="ds-comments-tab-duoshuo ds-current" href="javascript:void(0);"></a></li>'+(a.show_reposts&&t.reposts?'<li class="ds-tab"><a class="ds-comments-tab-repost" href="javascript:void(0);"></a></li>':"")+(a.show_weibo&&t.weibo_reposts?'<li class="ds-tab"><a class="ds-comments-tab-weibo" href="javascript:void(0);"></a></li>':"")+(a.show_qqt&&t.qqt_reposts?'<li class="ds-tab"><a class="ds-comments-tab-qqt" href="javascript:void(0);"></a></li>':"")+"</ul>"+"</div>"},N.PostListHead=function(e){this.embedThread=e},N.PostListHead.prototype={render:function(){var e=this.embedThread,t=e.options,a=e.postList,i=this.el=x(Y.postListHead(e)),s=i.find("ul.ds-comments-tabs").delegate(".ds-tab a","click",function(t){s.find("a.ds-current").removeClass("ds-current"),a.params.page=1;var i=t.currentTarget;switch(i.className){case"ds-comments-tab-duoshuo":a.params.source="duoshuo",e.replybox.el.show();break;case"ds-comments-tab-repost":a.params.source="repost",e.replybox.el.hide();break;case"ds-comments-tab-weibo":a.params.source="weibo",e.replybox.el.hide();break;case"ds-comments-tab-qqt":a.params.source="qqt",e.replybox.el.hide()}return x(i).addClass("ds-current"),a.refetch(),!1}),n=i.find(".ds-sort").delegate("a","click",function(){return n.find("a.ds-current").removeClass("ds-current"),a.params.order=t.order=this.className.replace("ds-order-",""),a.params.page=1,a.refetch(),x(this).addClass("ds-current"),!1});return n.find(".ds-order-"+a.params.order).addClass("ds-current"),this}},N.Paginator=function(e){e=e||{};var t=this,a=t.el=e.el||x('<div class="ds-paginator"></div>'),i=t.collection=e.collection;a.delegate("a","click",function(){return i.params.page=parseInt(this.innerHTML),i.refetch(),a.find(".ds-current").removeClass("ds-current"),x(this).addClass("ds-current"),!1})},N.Paginator.prototype={reset:function(e){function t(e){s.push('<a data-page="'+e+'" href="javascript:void(0);">'+e+"</a>")}var a,i=this.collection.params.page||1,s=[];if(i>1)for(t(1),a=i>4?i-2:2,a>2&&s.push('<span class="page-break">...</span>');i>a;a++)t(a);if(s.push('<a data-page="'+i+'" href="javascript:void(0);" class="ds-current">'+i+"</a>"),i<e.pages){for(a=i+1;i+4>=a&&a<e.pages;a++)t(a);a<e.pages&&s.push('<span class="page-break">...</span>'),t(e.pages)}this.el.html('<div class="ds-border"></div>'+s.join(" "))[e.pages>1?"show":"hide"]()}},Y.smiliesTooltip=function(e){var t='<div id="ds-smilies-tooltip"><ul class="ds-smilies-tabs">';for(var a in e)t+="<li><a>"+a+"</a></li>";return t+'</ul><div class="ds-smilies-container"></div></div>'},P.addSmilies=function(e,t){var a=P.smiliesTooltip;a&&a.el.find("ul.ds-smilies-tabs").append("<li><a>"+e+"</a></li>"),P.smilies[e]=t},N.SmiliesTooltip=function(){},N.SmiliesTooltip.prototype={render:function(){var e=this,a=e.el=x(Y.smiliesTooltip(Z));return a.click(A).find("ul.ds-smilies-tabs").delegate("a","click",function(){e.reset(this.innerHTML)}),a.find(".ds-smilies-container").delegate("img","click",function(){var a=e.replybox,i=a.el.find("textarea")[0],s=i.value;if(t.selection){i.value=s.substring(0,T.start)+this.title+s.substring(T.end,s.length),i.value=i.value.replace(I.leave_a_message,""),i.focus();var n=t.selection.createRange();n.moveStart("character",T.start+this.title.length),n.collapse(),n.select()}else{var o=i.selectionStart+this.title.length;i.value=s.substring(0,i.selectionStart)+this.title+s.substring(i.selectionEnd),i.setSelectionRange(o,o)}a.hideSmilies(),i.focus()}),this},reset:function(e){var t=this.el.find("ul.ds-smilies-tabs");t.find("a.ds-current").removeClass("ds-current"),t.find("a").filter(function(){return this.innerHTML==e}).addClass("ds-current");var a="<ul>";return x.each(Z[e],function(t,i){var s=0===e.indexOf("微博")?"http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/"+i.replace("_org","_thumb"):E+"/images/smilies/"+i;"WordPress"===e&&(t=" "+t+" "),a+='<li><img src="'+s+'" title="'+_(t)+'" /></li>'}),a+="</ul>",this.el.find(".ds-smilies-container").html(a),this}},Y.postPlaceholder=function(){return'<li class="ds-post ds-post-placeholder">'+I.no_comments_yet+"</li>"},Y.post=function(e,t){var a=et(e),i=a.user_id?' data-user-id="'+a.user_id+'"':"",s=a.qqt_account||"",n=Y.timeHtml(e.created_at,e.url),o=e.parents||[];switch(e.source){case"duoshuo":n+='<a class="ds-post-reply" href="javascript:void(0);"><span class="ds-icon ds-icon-reply"></span>'+I.reply+"</a>"+Y.likePost(e)+'<a class="ds-post-repost" href="javascript:void(0);"><span class="ds-icon ds-icon-share"></span>'+I.repost+"</a>"+'<a class="ds-post-report" href="javascript:void(0);"><span class="ds-icon ds-icon-report"></span>'+I.report+"</a>"+(e.privileges["delete"]?'<a class="ds-post-delete" href="javascript:void(0);"><span class="ds-icon ds-icon-delete"></span>'+I["delete"]+"</a>":"");break;case"qqt":case"weibo":n+='<a class="ds-weibo-comments" href="javascript:void(0);">'+I.comments+(e.type.match(/\-comment$/)?"":'(<span class="ds-count">'+e.comments+"</span>)")+"</a>"+'<a class="ds-weibo-reposts" href="javascript:void(0);">'+I.reposts+(e.type.match(/\-comment$/)?"":'(<span class="ds-count">'+e.reposts+"</span>)")+"</a>"}return'<li class="ds-post" data-post-id="'+e.post_id+'"><div class="ds-post-self" data-post-id="'+e.post_id+'" data-thread-id="'+e.thread_id+'" data-root-id="'+e.root_id+'" data-source="'+e.source+'"><div class="ds-avatar"'+i+">"+Y.avatar(a)+(P.sourceName[e.source]?Y.serviceIcon(e.source):"")+'</div><div class="ds-comment-body"><div class="ds-comment-header">'+(a.url?'<a class="ds-user-name ds-highlight" data-qqt-account="'+s+'" href="'+_(a.url)+'" '+(a.user_id?" onclick=\"this.href='"+P.hostUrl+"/user-url/?user_id="+a.user_id+"';\"":"")+' rel="nofollow" target="_blank"'+i+">"+_(a.name)+"</a>":'<span class="ds-user-name"'+i+' data-qqt-account="'+s+'">'+_(a.name)+"</span>")+"</div>"+(1==t.max_depth&&t.show_context&&o.length?'<ol id="ds-ctx">'+x.map(o,function(e,t){return(1==t&&o.length>2?'<li class="ds-ctx-entry"><a href="javascript:void(0);" class="ds-expand">还有'+(o.length-2)+"条评论</a></li>":"")+(ut[e]?Y.ctxPost(ut[e].data,t,t&&t<o.length-1):"")}).join("")+"</ol>":"")+"<p>"+(o.length>=t.max_depth&&(!t.show_context||t.max_depth>1)&&e.parent_id&&ut[e.parent_id]?'<a class="ds-comment-context" data-post-id="'+e.post_id+'" data-parent-id="'+e.parent_id+'">'+I.reply_to+_(et(ut[e.parent_id].data).name)+": </a>":"")+e.message+'</p><div class="ds-comment-footer ds-comment-actions'+(e.vote>0?" ds-post-liked":"")+'">'+n+"</div></div></div>"+(t.max_depth>1&&(e.childrenArray||e.children)&&"weibo"!=e.source&&"qqt"!=e.source?'<ul class="ds-children">'+x.map(e.childrenArray||e.children,function(e){return ut[e]?Y.post(ut[e].data,t):""}).join("")+"</ul>":"")+"</li>"};var mt=x('<div id="ds-bubble"><div class="ds-bubble-content"></div><div class="ds-arrow ds-arrow-down ds-arrow-border"></div><div class="ds-arrow ds-arrow-down"></div></div>'),vt=mt.find(".ds-bubble-content").delegate("a.ds-ctx-open","click",function(){H("/api/posts/conversation",{post_id:vt.attr("data-post-id")},function(t){e.el.find("ol").html(x.map(t.response,Y.ctxPost).join("\n"))});var e=V('<h2>查看对话</h2><ol id="ds-ctx"></ol>');return e.el.find(".ds-dialog").css("width","600px"),e.el.find(".ds-dialog-body").css({"max-height":"350px",_height:"350px","overflow-y":"auto","padding-top":"10px"}),!1}),gt=bubbleOutTimer=0,bt=function(){bubbleOutTimer&&(clearTimeout(bubbleOutTimer),bubbleOutTimer=0)};bubbleOut=function(){bubbleOutTimer=setTimeout(function(){bubbleOutTimer=0,mt.detach()},400)},mt.mouseenter(bt).mouseleave(bubbleOut),Y.userInfo=function(e){var t=[];return x.each(e.social_uid,function(e,a){t.push('<a href="'+P.REMOTE+"/user-proxy/"+e+"/"+a+'/" target="_blank" class="ds-service-icon ds-'+e+'" title="'+P.sourceName[e]+'"></a>')}),'<a href="'+_(e.url)+'" class="ds-avatar" target="_blank">'+Y.avatarImg(e)+'</a><a href="'+_(e.url)+'" class="ds-user-name ds-highlight" target="_blank">'+_(e.name)+"</a>"+t.join("")+'<p class="ds-user-card-meta"><a href="'+P.REMOTE+"/profile/"+e.user_id+'/" target="_blank"><span class="ds-highlight">'+e.comments+"</span>条评论</a></p>"+(e.description?'<p class="ds-user-description">'+_(e.description)+"</p>":"")},D.PostList=function(e){e&&(e.params&&(this.params=e.params),e.embedThread&&(this.embedThread=e.embedThread)),this.el=x('<ul class="ds-comments"></ul>')},D.PostList.prototype={url:"/api/threads/listPosts",render:function(){return u.call(this.el,this.embedThread,this.embedThread.options),this},reset:function(e){var t=this.embedThread.options;this.el.html(e[0]?x.map(e,function(e){return ut[e]?Y.post(ut[e].data,t):""}).join(""):Y.postPlaceholder())},refetch:function(){var e=this,a=x(Y.indicator()).appendTo(t.body).fadeIn(200);e.el.fadeTo(200,.5),H(e.url,e.params,function(t){i(ut,t.parentPosts||t.relatedPosts),i(pt,t.users),e.reset(t.response),e.embedThread.paginator.reset(t.cursor),e.el.fadeTo(200,1),P.scrollTo(e.el),a.remove()})}},P.repostDialog=function(e,t,a,i){var s=V('<h2>转发到微博</h2><div class="ds-quote"><strong>@'+_(et(e.data).name)+"</strong>: "+e.data.message+"</div>"+"<form>"+tt({post_id:e.data.post_id})+'<div class="ds-textarea-wrapper">'+'<textarea name="message" title="Ctrl+Enter快捷提交" placeholder="'+_(I.repost_reason)+'">'+_(t)+"</textarea>"+'<pre class="ds-hidden-text"></pre>'+"</div>"+'<div class="ds-actions">'+(i?tt({"service[]":i}):'<label><input type="checkbox" name="service[]" value="weibo"'+(dt.data.social_uid.weibo?' checked="checked"':"")+' /><span class="ds-service-icon ds-weibo"></span>新浪微博</label>  '+'<label><input type="checkbox" name="service[]" value="qqt"'+(dt.data.social_uid.qq?' checked="checked"':"")+' /><span class="ds-service-icon ds-qqt"></span>腾讯微博</label>')+'<button type="submit">'+I.repost+"</button>"+"</div>"+"</form>"),n=s.el.find("form").submit(function(){return i||n.find("[type=checkbox]:checked")[0]?(W("/api/posts/repost",P.toJSON(n),function(e){if(a&&i){var t=a.options,s=l(a.postList.el,e.response[i],t);"asc"==t.order==("top"==t.formPosition)&&P.scrollTo(s);var n=a.el.find(".ds-comments-tab-"+i+" span.ds-highlight");n.html(parseInt(n.html())+1)}}),s.close(),!1):(alert("还没有选发布到哪儿呢"),!1)});return n.find(".ds-actions [type=checkbox]").change(function(){var e=this.value;return this.checked&&!dt.data.social_uid["qqt"==e?"qq":e]?(f(e),void 0):void 0}),it(n.find("textarea")).keyup(B).keyup(F).focus(),!1},Y.toolbar=function(){var e=Y.logoutUrl();return'<div class="ds-toolbar"><div class="ds-account-control"><span class="ds-icon ds-icon-settings"></span> <span>帐号管理</span><ul><li><a class="ds-bind-more" href="javascript:void(0);" style="border-top: none">绑定更多</a></li><li><a target="_blank" href="'+P.REMOTE+"/settings/"+K(J())+'">'+_(I.settings)+"</a></li>"+'<li><a rel="nofollow" href="'+e+'" style="border-bottom: none">登出</a></li>'+"</ul>"+"</div>"+'<div class="ds-visitor">'+(dt.data.url?'<a class="ds-visitor-name" href="'+_(dt.data.url)+'" target="_blank">'+_(dt.data.name)+"</a>":'<span class="ds-visitor-name">'+_(dt.data.name)+"</span>")+'<a class="ds-unread-comments-count" href="javascript:void(0);" title="新回复"></a>'+"</div>"+"</div>"},N.EmbedThread=ht.extend({uri:"/api/threads/listPosts",params:"thread-id local-thread-id source-thread-id thread-key category channel-key author-key author-id url limit order max-depth form-position container-url"+(y.match(/MSIE 6\.0/)?"":" title image thumbnail"),render:function(){var e=this.el.attr("id","ds-thread").append(Y.waitingImg()),t=e.width(),a=e.data("url")||!e.attr("data-thread-id")&&x("link[rel=canonical]").attr("href");a?e.data("url",k(a)):e.data("container-url",h.href),t&&400>=t&&e.addClass("ds-narrow").data("max-depth",1)},updateCounter:function(e){var t={duoshuo:["comments","评论"],repost:["reposts","转载"],weibo:["weibo_reposts","新浪微博"],qqt:["qqt_reposts","腾讯微博"]};for(var a in t)if(!e||e==a){var i=this.data[t[a][0]];this.el.find(".ds-comments-tab-"+a).html(this.el.hasClass("ds-narrow")?'<span class="ds-service-icon ds-'+a+'"></span>'+i:(i?'<span class="ds-highlight">'+i+"</span>条":"")+t[a][1])}},onError:function(e){this.el.html("评论框出错啦("+e.code+"): "+e.errorMessage)},onload:function(t){var s=this,n=s.threadId=t.thread.thread_id,r=t.cursor,d=s.options=t.options,l=s.innerEl=at(x('<div id="ds-reset"></div>').appendTo(s.el));s.data=t.thread,i(ut,t.parentPosts||t.relatedPosts),i(pt,t.users),s.el.find("#ds-waiting").remove(),d.like_thread_enabled&&(s.meta=new N.Meta(s),s.meta.render().el.appendTo(l)),d.hot_posts&&t.hotPosts&&t.hotPosts.length&&(s.hotPosts=new N.HotPosts(x('<div class="ds-rounded"></div>'),{max_depth:1,show_context:d.show_context}),s.hotPosts.thread=s,s.hotPosts.el.appendTo(l),s.hotPosts.onload({response:t.hotPosts,options:{}})),s.postListHead=new N.PostListHead(s),s.postList=new D.PostList({embedThread:s,params:{source:"duoshuo",thread_id:n,max_depth:d.max_depth,order:d.order,limit:d.limit}}),s.postList.render().reset(t.response),s.paginator=new N.Paginator({collection:s.postList}),s.paginator.reset(r);var c=s.replybox=new N.Replybox(s),u=c.render().el.find("textarea");if(c.postList=s.postList.el,v){var p="ds_draft_"+n;u.bind("focus blur keyup",function(e){var t=x(e.currentTarget).val();try{v[p]=t}catch(e){}}),v[p]&&u.val(v[p])}if(o()){var h=x(Y.loginButtons()).delegate("a.ds-more-services","click",function(){return h.find(".ds-additional-services").toggle(),!1});G(h)}else s.toolbar=x(Y.toolbar()).delegate(".ds-account-control","mouseenter",function(){x(this).addClass("ds-active")}).delegate(".ds-account-control","mouseleave",function(){x(this).removeClass("ds-active")}).delegate("a.ds-bind-more","click",function(){var e=V("<h2>绑定更多帐号</h2>"+Y.serviceList(1)+Y.additionalServices(1)+'<div style="clear:both"></div>').el.find(".ds-dialog").addClass("ds-dialog-bind-more").css("width","300px");return G(e),!1}).delegate("a.ds-unread-comments-count","click",function(){return ft("unread-comments"),!1});s.postListHead.render().el.appendTo(l)["top"==d.formPosition?"before":"after"]('<a name="respond"></a>',s.toolbar||h,c.el).after(s.postList.el,s.paginator.el),s.updateCounter(),t.alerts&&x.each(t.alerts,function(e,t){x('<div class="ds-alert">'+t+"</div>").insertBefore(s.toolbar||h)}),d.message&&u.val(d.message).focus(),x(Y.poweredBy(d.poweredby_text)).appendTo(l),lt.on("reset",function(){var e=lt.data.comments||0;l.find("a.ds-unread-comments-count").html(e).attr("title",e?"你有"+e+"条新回复":"你没有新回复").css("display",e?"inline":"none")}),d.mzadx_id&&(P.require("mzadxN",function(){}),x('<div id="MZADX_'+d.mzadx_id+'" style="margin:0 auto;"></div>').appendTo(l),__mz_rpq=e.__mz_rpq||[],__mz_rpq.push({l:[d.mzadx_id],r:"1",_srv:"MZADX",_callback:function(){}})),P.thread=s,lt.data!==a&&lt.trigger("reset"),o()||z({visit_thread_id:s.threadId})},onMessage:function(e){l(this.postList.el,e,this.options)}}),Y.hotPosts=function(e,t){return'<div class="ds-header ds-gradient-bg">'+I.hot_posts_title+"</div><ul>"+x.map(e,function(e){return ut[e]?Y.post(ut[e].data,t):""}).join("")+"</ul>"},N.HotPosts=ht.extend({params:"show-quote",tmpl:"hotPosts",render:function(){return this.el.attr("id","ds-hot-posts"),this},onload:function(e){ht.prototype.onload.call(this,e),u.call(this.el.find("ul"),this.thread,this.options)}}),Y.commentList=function(e,t){return x.map(e,function(e){var a=et(e);return'<li class="ds-comment'+(t.show_avatars?" ds-show-avatars":"")+'" data-post-id="'+e.post_id+'">'+(t.show_avatars?'<div class="ds-avatar">'+Y.avatar(a,t.avatar_size)+"</div>":"")+'<div class="ds-meta">'+Y.userAnchor(a)+(t.show_time?Y.timeHtml(e.created_at):"")+"</div>"+(t.show_title?'<div class="ds-thread-title">在 <a href="'+_(e.thread.url+"#comments")+'">'+_(e.thread.title)+'</a> 中评论</div><div class="ds-excerpt">'+e.message+"</div>":'<a class="ds-excerpt" title="'+_(e.thread.title)+' 中的评论" href="'+_(e.thread.url+"#comments")+'">'+e.message+"</a>")+"</li>"}).join("")},N.RecentComments=ht.extend({uri:"/api/sites/listRecentPosts",params:"show-avatars show-time show-title avatar-size show-admin excerpt-length num-items channel-key",tmpl:"commentList",render:function(){this.el.attr("id","ds-recent-comments")}}),Y.recentVisitors=function(e,t){return x.map(e,function(e){return'<div class="ds-avatar">'+Y.avatar(e,t.avatar_size)+"</div>"}).join("")},N.RecentVisitors=ht.extend({uri:"/api/sites/listVisitors",params:"show-time avatar-size num-items channel-key",tmpl:"recentVisitors",render:function(){this.el.children().detach(),this.el.attr("id","ds-recent-visitors").append(this.waitingEl=x(Y.waitingImg()))}}),Y.topUsers=function(e,t){return x.map(e,function(e){return'<div class="ds-avatar">'+Y.avatar(e,t.avatar_size)+"<h4>"+e.name+"</h4>"+"</div>"}).join("")},N.TopUsers=ht.extend({uri:"/api/sites/listTopUsers",params:"show-time avatar-size num-items channel-key",tmpl:"topUsers",render:function(){this.el.children().detach(),this.el.attr("id","ds-top-users").append(this.waitingEl=x(Y.waitingImg()))}}),Y.topThreads=function(e){return x.map(e,function(e){return'<li><a target="_blank" href="'+_(e.url)+'" title="'+e.title+'">'+e.title+"</a>"+"</li>"}).join("")},N.TopThreads=ht.extend({uri:"/api/sites/listTopThreads",params:"range num-items channel-key",tmpl:"topThreads",render:function(){this.el.children().detach(),this.el.attr("id","ds-top-threads").append(this.waitingEl=x(Y.waitingImg()))}}),Y.loginWidget=function(){var e='<div class="ds-icons-32">';return x.each(["weibo","qq","renren","kaixin","douban","netease","sohu"],function(t,a){e+='<a class="ds-'+a+'" href="'+Y.loginUrl(a)+'">'+P.sourceName[a]+"</a>"}),e+"</div>"},N.LoginWidget=ht.extend({tmpl:"loginWidget",render:function(){var e=this.el;e.attr("id","ds-login").html(Y.loginWidget()),G(e,"a"),e.find("a.ds-logout").attr("href",Y.logoutUrl())}}),N.ThreadCount=ht.extend({onload:function(e){var t=this.el,a=t.data("count-type")||"comments",i=e.data[a];t[t.data("replace")?"replaceWith":"html"](I[a+"_"+(i?i>1?"multiple":"one":"zero")].replace("{num}",i))}});var yt=0;P.initSelector=function(e,t){var a=[];X()&&(x.isReady||!q)&&x(e).each(function(e,i){var s=x(i);if(!s.data("initialized")){s.data("initialized",!0);var n=new N[t.type](s,t);if(R.push(n),"ThreadCount"===t.type){var o=s.attr("data-thread-key");s.attr("data-channel-key")&&(o=s.attr("data-channel-key")+":"+o),a.push(o),ct[o]||(ct[o]=new nt({})),ct[o].on("reset",function(){n.onload(this)})}else if(n.uri){var r={};x.each(n.params.split(" "),function(e,t){r[t.replace(/-/g,"_")]=s.attr("data-"+t)||s.data(t)}),H(n.uri,b(r),function(e){n.load(e)})}}}),a.length&&H("/api/threads/counts",b({threads:a.join(",")}),function(e){U(e),s(I,e.options),i(ct,e.response)})},(P.initView=function(){x.each(M,P.initSelector)})(),x(function(){return X()?(setInterval(function(){x(".ds-time").each(function(){var e=x(this).attr("datetime");e&&(this.innerHTML=P.elapsedTime(e))})},2e4),p.ondomready&&p.ondomready(),P.initView(),!yt&&p.short_name&&H("/api/analytics/ping",b({}),U),void 0):Q("缺少duoshuoQuery的定义")})})}}(window,document);